@page
@model CloudOps.Web.Pages.Dashboard.HostedAgentsModel
@{
    ViewData["Title"] = "Hosted Agents";
    Layout = "Shared/_DashboardLayout";
}

<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
    }
    .modal.show { display: flex; align-items: center; justify-content: center; }
    .modal-content {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 0.75rem;
        padding: 1.5rem;
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    .modal-title { font-size: 1.25rem; font-weight: 600; color: var(--foreground); }
    .modal-close {
        background: none;
        border: none;
        color: var(--muted-foreground);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }
    .modal-close:hover { color: var(--foreground); }
    .form-group { margin-bottom: 1rem; }
    .form-label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--muted-foreground); }
    .form-input {
        width: 100%;
        padding: 0.625rem 0.875rem;
        background: var(--background);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        color: var(--foreground);
        font-size: 0.875rem;
    }
    .form-input:focus { outline: none; border-color: var(--primary); }
    .form-select {
        width: 100%;
        padding: 0.625rem 0.875rem;
        background: var(--background);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        color: var(--foreground);
        font-size: 0.875rem;
        cursor: pointer;
    }
    .modal-footer { display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem; }
    .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
    .tab-btn {
        padding: 0.5rem 1rem;
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        color: var(--muted-foreground);
        cursor: pointer;
        font-size: 0.875rem;
    }
    .tab-btn.active { background: var(--primary); border-color: var(--primary); color: var(--primary-foreground); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .api-key-display {
        background: var(--background);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        padding: 1rem;
        font-family: monospace;
        font-size: 0.875rem;
        word-break: break-all;
        margin: 1rem 0;
    }
    .copy-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--secondary);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        color: var(--foreground);
        cursor: pointer;
        font-size: 0.875rem;
    }
    .copy-btn:hover { background: var(--accent); }
    .agent-card {
        background: var(--card-darker);
        border: 1px solid var(--border);
        border-radius: 0.75rem;
        padding: 1.25rem;
        margin-bottom: 1rem;
    }
    .agent-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
    .agent-name { font-size: 1rem; font-weight: 600; color: var(--foreground); }
    .agent-meta { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; font-size: 0.875rem; }
    .agent-meta-item { color: var(--muted-foreground); }
    .agent-meta-value { color: var(--foreground); }
    .agent-actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
    .progress-bar-container { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; margin-top: 0.5rem; }
    .progress-bar-fill { height: 100%; background: var(--primary); transition: width 0.3s ease; }
</style>

<h1 class="page-title">Hosted Agents</h1>
<p class="page-description">Register and manage self-hosted agents for executing jobs in private networks</p>

<div class="grid grid-4" style="margin-bottom: 2rem;">
    <div class="stat-card">
        <div class="stat-label">Total Agents</div>
        <div class="stat-value" id="totalAgents">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Online</div>
        <div class="stat-value" id="onlineAgents">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Busy</div>
        <div class="stat-value" id="busyAgents">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Offline</div>
        <div class="stat-value" id="offlineAgents">-</div>
    </div>
</div>

<div class="tabs">
    <button class="tab-btn active" data-tab="agents">Agents</button>
    <button class="tab-btn" data-tab="jobs">Jobs</button>
</div>

<div id="agentsTab" class="tab-content active">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--foreground); margin: 0;">Registered Agents</h2>
            <div style="display: flex; gap: 0.75rem;">
                <button id="registerAgentBtn" class="btn btn-primary" style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-plus"></i>
                    <span>Register Agent</span>
                </button>
                <button id="refreshAgentsBtn" class="btn btn-secondary" style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-sync-alt"></i>
                    <span>Refresh</span>
                </button>
            </div>
        </div>
        
        <div id="agentsLoadingState" style="text-align: center; padding: 2rem; color: var(--muted-foreground);">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <p>Loading agents...</p>
        </div>
        
        <div id="agentsEmptyState" style="text-align: center; padding: 3rem; color: var(--muted-foreground); display: none;">
            <i class="fas fa-server" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <p style="font-size: 1.1rem;">No agents registered</p>
            <p style="font-size: 0.9rem;">Click "Register Agent" to add your first self-hosted agent.</p>
        </div>
        
        <div id="agentsContainer" style="display: none;"></div>
    </div>
</div>

<div id="jobsTab" class="tab-content">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--foreground); margin: 0;">Job Queue</h2>
            <div style="display: flex; gap: 0.75rem;">
                <button id="createJobBtn" class="btn btn-primary" style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-plus"></i>
                    <span>Create Job</span>
                </button>
                <button id="refreshJobsBtn" class="btn btn-secondary" style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-sync-alt"></i>
                    <span>Refresh</span>
                </button>
            </div>
        </div>
        
        <div id="jobsLoadingState" style="text-align: center; padding: 2rem; color: var(--muted-foreground);">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <p>Loading jobs...</p>
        </div>
        
        <div id="jobsEmptyState" style="text-align: center; padding: 3rem; color: var(--muted-foreground); display: none;">
            <i class="fas fa-tasks" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <p style="font-size: 1.1rem;">No jobs in queue</p>
            <p style="font-size: 0.9rem;">Jobs will appear here when agents execute tasks.</p>
        </div>
        
        <div id="jobsTableContainer" style="display: none; overflow-x: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Job Name</th>
                        <th>Type</th>
                        <th>Agent</th>
                        <th>Status</th>
                        <th>Progress</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="jobsTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="registerAgentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Register New Agent</h3>
            <button class="modal-close" onclick="closeModal('registerAgentModal')">&times;</button>
        </div>
        <form id="registerAgentForm">
            <div class="form-group">
                <label class="form-label">Agent Name *</label>
                <input type="text" class="form-input" name="name" required placeholder="e.g., prod-backup-agent-01">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" class="form-input" name="description" placeholder="e.g., Production database backup agent">
            </div>
            <div class="form-group">
                <label class="form-label">Max Parallel Jobs</label>
                <input type="number" class="form-input" name="maxParallelJobs" value="1" min="1" max="10">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('registerAgentModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Register</button>
            </div>
        </form>
    </div>
</div>

<div id="agentCreatedModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Agent Registered Successfully</h3>
            <button class="modal-close" onclick="closeModal('agentCreatedModal')">&times;</button>
        </div>
        <p style="color: var(--muted-foreground); margin-bottom: 1rem;">
            Your agent has been registered. Use the following API key to authenticate:
        </p>
        <div class="api-key-display" id="newAgentApiKey"></div>
        <p style="color: var(--destructive); font-size: 0.875rem; margin-bottom: 1rem;">
            <i class="fas fa-exclamation-triangle"></i> Save this key now! It will not be shown again.
        </p>
        <button class="copy-btn" onclick="copyApiKey()">
            <i class="fas fa-copy"></i>
            <span>Copy API Key</span>
        </button>
        <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="closeModal('agentCreatedModal')">Done</button>
        </div>
    </div>
</div>

<div id="createJobModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Create New Job</h3>
            <button class="modal-close" onclick="closeModal('createJobModal')">&times;</button>
        </div>
        <form id="createJobForm">
            <div class="form-group">
                <label class="form-label">Target Agent *</label>
                <select class="form-select" name="agentId" required id="jobAgentSelect">
                    <option value="">Select an agent...</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Job Type *</label>
                <select class="form-select" name="jobType" required>
                    <option value="DatabaseBackup">Database Backup</option>
                    <option value="DatabaseRestore">Database Restore</option>
                    <option value="FileSync">File Sync</option>
                    <option value="ScriptExecution">Script Execution</option>
                    <option value="Custom">Custom</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Job Name *</label>
                <input type="text" class="form-input" name="jobName" required placeholder="e.g., Backup production DB">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" class="form-input" name="description" placeholder="Job description">
            </div>
            <div class="form-group">
                <label class="form-label">Parameters (JSON)</label>
                <textarea class="form-input" name="parameters" rows="3" placeholder='{"database": "mydb", "target": "/backups"}'></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Priority</label>
                <select class="form-select" name="priority">
                    <option value="0">Low</option>
                    <option value="1" selected>Normal</option>
                    <option value="2">High</option>
                    <option value="3">Critical</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('createJobModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Job</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
<script>
    let agents = [];
    let jobs = [];
    let currentApiKey = '';
    
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(this.dataset.tab + 'Tab').classList.add('active');
        });
    });
    
    async function loadAgents() {
        const loading = document.getElementById('agentsLoadingState');
        const empty = document.getElementById('agentsEmptyState');
        const container = document.getElementById('agentsContainer');
        
        loading.style.display = 'block';
        empty.style.display = 'none';
        container.style.display = 'none';
        
        try {
            const response = await fetch('/api/agents');
            if (!response.ok) throw new Error('Failed to load agents');
            agents = await response.json();
            
            loading.style.display = 'none';
            
            if (agents.length === 0) {
                empty.style.display = 'block';
            } else {
                container.style.display = 'block';
                renderAgents(agents);
            }
            
            updateStats();
            updateJobAgentSelect();
        } catch (error) {
            console.error('Error loading agents:', error);
            loading.innerHTML = '<i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; color: var(--destructive);"></i><p>Failed to load agents</p>';
        }
    }
    
    async function loadJobs() {
        const loading = document.getElementById('jobsLoadingState');
        const empty = document.getElementById('jobsEmptyState');
        const container = document.getElementById('jobsTableContainer');
        
        loading.style.display = 'block';
        empty.style.display = 'none';
        container.style.display = 'none';
        
        try {
            const response = await fetch('/api/jobs');
            if (!response.ok) throw new Error('Failed to load jobs');
            jobs = await response.json();
            
            loading.style.display = 'none';
            
            if (jobs.length === 0) {
                empty.style.display = 'block';
            } else {
                container.style.display = 'block';
                renderJobs(jobs);
            }
        } catch (error) {
            console.error('Error loading jobs:', error);
            loading.innerHTML = '<i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; color: var(--destructive);"></i><p>Failed to load jobs</p>';
        }
    }
    
    function updateStats() {
        const online = agents.filter(a => a.status === 'Online').length;
        const busy = agents.filter(a => a.status === 'Busy').length;
        const offline = agents.filter(a => a.status === 'Offline').length;
        
        document.getElementById('totalAgents').textContent = agents.length;
        document.getElementById('onlineAgents').textContent = online;
        document.getElementById('busyAgents').textContent = busy;
        document.getElementById('offlineAgents').textContent = offline;
    }
    
    function updateJobAgentSelect() {
        const select = document.getElementById('jobAgentSelect');
        select.innerHTML = '<option value="">Select an agent...</option>';
        agents.filter(a => a.status !== 'Offline').forEach(agent => {
            select.innerHTML += '<option value="' + agent.id + '">' + escapeHtml(agent.name) + ' (' + agent.status + ')</option>';
        });
    }
    
    function renderAgents(agentList) {
        const container = document.getElementById('agentsContainer');
        container.innerHTML = '';
        
        agentList.forEach(agent => {
            const statusClass = getStatusClass(agent.status);
            const card = document.createElement('div');
            card.className = 'agent-card';
            card.innerHTML = 
                '<div class="agent-header">' +
                    '<div>' +
                        '<div class="agent-name">' + escapeHtml(agent.name) + '</div>' +
                        '<div style="font-size: 0.875rem; color: var(--muted-foreground);">' + escapeHtml(agent.description || 'No description') + '</div>' +
                    '</div>' +
                    '<span class="badge ' + statusClass + '">' + agent.status + '</span>' +
                '</div>' +
                '<div class="agent-meta">' +
                    '<div class="agent-meta-item">Host: <span class="agent-meta-value">' + escapeHtml(agent.hostName || 'Not connected') + '</span></div>' +
                    '<div class="agent-meta-item">IP: <span class="agent-meta-value">' + escapeHtml(agent.ipAddress || '-') + '</span></div>' +
                    '<div class="agent-meta-item">OS: <span class="agent-meta-value">' + escapeHtml(agent.operatingSystem || '-') + '</span></div>' +
                    '<div class="agent-meta-item">Version: <span class="agent-meta-value">' + escapeHtml(agent.agentVersion || '-') + '</span></div>' +
                    '<div class="agent-meta-item">Jobs: <span class="agent-meta-value">' + agent.currentRunningJobs + '/' + agent.maxParallelJobs + '</span></div>' +
                    '<div class="agent-meta-item">Last Seen: <span class="agent-meta-value">' + formatDateTime(agent.lastHeartbeat) + '</span></div>' +
                '</div>' +
                '<div class="agent-actions">' +
                    '<button class="btn btn-secondary btn-sm" onclick="deleteAgent(\'' + agent.id + '\')"><i class="fas fa-trash"></i> Delete</button>' +
                '</div>';
            container.appendChild(card);
        });
    }
    
    function renderJobs(jobList) {
        const tbody = document.getElementById('jobsTableBody');
        tbody.innerHTML = '';
        
        jobList.forEach(job => {
            const statusClass = getJobStatusClass(job.status);
            const row = document.createElement('tr');
            row.innerHTML = 
                '<td>' + escapeHtml(job.jobName) + '</td>' +
                '<td>' + escapeHtml(job.jobType) + '</td>' +
                '<td>' + escapeHtml(job.agentName || 'Unassigned') + '</td>' +
                '<td><span class="badge ' + statusClass + '">' + job.status + '</span></td>' +
                '<td>' +
                    '<div style="display: flex; align-items: center; gap: 0.5rem;">' +
                        '<span>' + job.progress + '%</span>' +
                        '<div class="progress-bar-container" style="flex: 1;">' +
                            '<div class="progress-bar-fill" style="width: ' + job.progress + '%;"></div>' +
                        '</div>' +
                    '</div>' +
                '</td>' +
                '<td>' + formatDateTime(job.createdAt) + '</td>' +
                '<td>' +
                    (job.status === 'Pending' || job.status === 'Running' ? 
                        '<button class="btn btn-secondary btn-sm" onclick="cancelJob(\'' + job.id + '\')"><i class="fas fa-times"></i> Cancel</button>' : 
                        '-') +
                '</td>';
            tbody.appendChild(row);
        });
    }
    
    function getStatusClass(status) {
        switch (status) {
            case 'Online': return 'badge-success';
            case 'Busy': return 'badge-warning';
            case 'Offline': return 'badge-danger';
            default: return 'badge-secondary';
        }
    }
    
    function getJobStatusClass(status) {
        switch (status) {
            case 'Pending': return 'badge-secondary';
            case 'Running': return 'badge-warning';
            case 'Completed': return 'badge-success';
            case 'Failed': return 'badge-danger';
            case 'Cancelled': return 'badge-secondary';
            default: return 'badge-secondary';
        }
    }
    
    function formatDateTime(dateString) {
        if (!dateString) return 'Never';
        const date = new Date(dateString);
        return date.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function openModal(modalId) {
        document.getElementById(modalId).classList.add('show');
    }
    
    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
    }
    
    document.getElementById('registerAgentBtn').addEventListener('click', () => openModal('registerAgentModal'));
    document.getElementById('createJobBtn').addEventListener('click', () => {
        if (agents.filter(a => a.status !== 'Offline').length === 0) {
            alert('No online agents available. Please register an agent first.');
            return;
        }
        openModal('createJobModal');
    });
    
    document.getElementById('registerAgentForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        try {
            const response = await fetch('/api/agents', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: formData.get('name'),
                    description: formData.get('description'),
                    maxParallelJobs: parseInt(formData.get('maxParallelJobs')) || 1
                })
            });
            
            if (!response.ok) throw new Error('Failed to register agent');
            const agent = await response.json();
            
            currentApiKey = agent.apiKey;
            document.getElementById('newAgentApiKey').textContent = currentApiKey;
            
            closeModal('registerAgentModal');
            openModal('agentCreatedModal');
            this.reset();
            loadAgents();
        } catch (error) {
            console.error('Error registering agent:', error);
            alert('Failed to register agent: ' + error.message);
        }
    });
    
    document.getElementById('createJobForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        let parameters = null;
        const paramsStr = formData.get('parameters');
        if (paramsStr) {
            try {
                parameters = JSON.parse(paramsStr);
            } catch {
                alert('Invalid JSON in parameters field');
                return;
            }
        }
        
        try {
            const response = await fetch('/api/jobs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    agentId: formData.get('agentId'),
                    jobType: formData.get('jobType'),
                    jobName: formData.get('jobName'),
                    description: formData.get('description'),
                    parameters: parameters,
                    priority: parseInt(formData.get('priority')) || 1
                })
            });
            
            if (!response.ok) throw new Error('Failed to create job');
            
            closeModal('createJobModal');
            this.reset();
            loadJobs();
            document.querySelector('[data-tab="jobs"]').click();
        } catch (error) {
            console.error('Error creating job:', error);
            alert('Failed to create job: ' + error.message);
        }
    });
    
    async function deleteAgent(agentId) {
        if (!confirm('Are you sure you want to delete this agent?')) return;
        
        try {
            const response = await fetch('/api/agents/' + agentId, { method: 'DELETE' });
            if (!response.ok) throw new Error('Failed to delete agent');
            loadAgents();
        } catch (error) {
            console.error('Error deleting agent:', error);
            alert('Failed to delete agent: ' + error.message);
        }
    }
    
    async function cancelJob(jobId) {
        if (!confirm('Are you sure you want to cancel this job?')) return;
        
        try {
            const response = await fetch('/api/jobs/' + jobId + '/cancel', { method: 'POST' });
            if (!response.ok) throw new Error('Failed to cancel job');
            loadJobs();
        } catch (error) {
            console.error('Error cancelling job:', error);
            alert('Failed to cancel job: ' + error.message);
        }
    }
    
    function copyApiKey() {
        navigator.clipboard.writeText(currentApiKey).then(() => {
            const btn = document.querySelector('.copy-btn');
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-copy"></i> Copy API Key';
            }, 2000);
        });
    }
    
    document.getElementById('refreshAgentsBtn').addEventListener('click', function() {
        const icon = this.querySelector('i');
        icon.classList.add('fa-spin');
        loadAgents().finally(() => icon.classList.remove('fa-spin'));
    });
    
    document.getElementById('refreshJobsBtn').addEventListener('click', function() {
        const icon = this.querySelector('i');
        icon.classList.add('fa-spin');
        loadJobs().finally(() => icon.classList.remove('fa-spin'));
    });
    
    loadAgents();
    loadJobs();
</script>
}
