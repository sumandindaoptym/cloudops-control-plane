@page
@model CloudOps.Web.Pages.Dashboard.ServiceBusModel
@{
    ViewData["Title"] = "Service Bus DLQ Cleaner";
    Layout = "Shared/_DashboardLayout";
}

<style>
    .animated-btn {
        height: 45px;
        border-radius: 45px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background-color: hsl(220, 15%, 9%);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition-duration: 0.3s;
        overflow: hidden;
        position: relative;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .animated-btn:not(.animated-btn-large) {
        width: 120px;
    }

    .animated-btn-large {
        width: 160px;
        height: 50px;
    }

    .animated-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .icon-container {
        width: 35px;
        height: 35px;
        background: linear-gradient(135deg, hsl(175, 70%, 55%), hsl(175, 70%, 45%));
        border-radius: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        z-index: 2;
        transition-duration: 0.3s;
    }

    .animated-btn-large .icon-container {
        width: 40px;
        height: 40px;
    }

    .icon {
        color: hsl(220, 15%, 6%);
        font-size: 1rem;
    }

    .btn-text {
        height: 100%;
        width: 70px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        z-index: 1;
        transition-duration: 0.3s;
        font-size: 0.95rem;
        font-weight: 500;
    }

    .animated-btn-large .btn-text {
        width: 100px;
        font-size: 1.05rem;
        font-weight: 600;
    }

    .animated-btn:not(:disabled):hover .icon-container {
        width: 90px;
        transition-duration: 0.3s;
    }

    .animated-btn-large:not(:disabled):hover .icon-container {
        width: 150px;
        transition-duration: 0.3s;
    }

    .animated-btn:not(:disabled):hover .btn-text {
        transform: translate(10px);
        width: 0;
        font-size: 0;
        transition-duration: 0.3s;
    }

    .animated-btn:not(:disabled):active {
        transform: scale(0.95);
        transition-duration: 0.3s;
    }
</style>

<h1 class="page-title">Service Bus DLQ Cleaner</h1>
<p class="page-description">Manage dead-letter queues across your Azure Service Bus namespaces</p>

<div class="card" style="margin-bottom: 1.5rem; position: relative; z-index: 10;">
    <div class="grid grid-2" style="gap: 1rem; margin-bottom: 1rem;">
        <div>
            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--foreground);">Service Bus Namespace</label>
            <div style="position: relative;">
                <div style="position: relative;">
                    <input 
                        type="text" 
                        id="namespaceSearchInput" 
                        class="select" 
                        placeholder="Search namespaces..." 
                        autocomplete="off"
                        style="width: 100%; padding-right: 2.5rem;"
                    />
                    <i class="fas fa-search" style="position: absolute; right: 0.875rem; top: 50%; transform: translateY(-50%); color: var(--muted-foreground); pointer-events: none;"></i>
                </div>
                <div 
                    id="namespaceDropdown" 
                    style="
                        display: none;
                        position: absolute;
                        top: 100%;
                        left: 0;
                        right: 0;
                        background: var(--card);
                        border: 1px solid var(--border);
                        border-radius: 0.375rem;
                        margin-top: 0.25rem;
                        max-height: 300px;
                        overflow-y: auto;
                        z-index: 1000;
                        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
                    "
                >
                    <div id="namespaceList"></div>
                </div>
            </div>
            <input type="hidden" id="namespaceSelector" value="" />
        </div>
        <div>
            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--foreground);">Entity Type</label>
            <div style="display: flex; gap: 1rem; padding: 0.5rem 0;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="radio" name="entityType" value="queue" id="entityTypeQueue" checked />
                    <span>Queue</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="radio" name="entityType" value="topic" id="entityTypeTopic" />
                    <span>Topic</span>
                </label>
            </div>
        </div>
    </div>

    <div id="queueSection" class="grid grid-2" style="gap: 1rem;">
        <div>
            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--foreground);">Queue</label>
            <select id="queueSelector" class="select" style="width: 100%;" disabled>
                <option value="">Select a queue...</option>
            </select>
        </div>
    </div>

    <div id="topicSection" class="grid grid-2" style="gap: 1rem; display: none;">
        <div>
            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--foreground);">Topic</label>
            <select id="topicSelector" class="select" style="width: 100%;" disabled>
                <option value="">Select a topic...</option>
            </select>
        </div>
        <div>
            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--foreground);">Topic Subscriptions</label>
            <select id="topicSubscriptionSelector" class="select" style="width: 100%;" disabled>
                <option value="">Select a subscription...</option>
            </select>
        </div>
    </div>
</div>

<div id="dlqStatusCard" class="card" style="display: none; margin-bottom: 1.5rem; position: relative; z-index: 10;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--foreground); margin: 0;">Dead-Letter Queue</h2>
        <button id="refreshButton" class="animated-btn">
            <div class="icon-container">
                <i class="fas fa-sync-alt icon"></i>
            </div>
            <span class="btn-text">Refresh</span>
        </button>
    </div>

    <div class="grid grid-3" style="gap: 1.5rem; margin-bottom: 1.5rem;">
        <div style="padding: 1.5rem; background: linear-gradient(135deg, var(--card) 0%, hsl(220, 15%, 8%) 100%); border: 1px solid var(--border); border-radius: 0.5rem;">
            <div style="font-size: 0.875rem; color: var(--muted-foreground); margin-bottom: 0.5rem;">Dead-Letter Messages</div>
            <div id="dlqCount" style="font-size: 2rem; font-weight: 700; color: var(--primary);">-</div>
        </div>
        <div style="padding: 1.5rem; background: linear-gradient(135deg, var(--card) 0%, hsl(220, 15%, 8%) 100%); border: 1px solid var(--border); border-radius: 0.5rem;">
            <div style="font-size: 0.875rem; color: var(--muted-foreground); margin-bottom: 0.5rem;">Active Messages</div>
            <div id="activeCount" style="font-size: 2rem; font-weight: 700; color: var(--foreground);">-</div>
        </div>
        <div style="padding: 1.5rem; background: linear-gradient(135deg, var(--card) 0%, hsl(220, 15%, 8%) 100%); border: 1px solid var(--border); border-radius: 0.5rem;">
            <div style="font-size: 0.875rem; color: var(--muted-foreground); margin-bottom: 0.5rem;">Entity Type</div>
            <div id="entityTypeDisplay" style="font-size: 1.25rem; font-weight: 600; color: var(--foreground); text-transform: capitalize;">-</div>
        </div>
    </div>

    <div style="display: flex; gap: 1rem;">
        <button id="purgeButton" class="animated-btn animated-btn-large" disabled>
            <div class="icon-container">
                <svg class="icon" style="width: 1.25rem; height: 1.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
            </div>
            <span class="btn-text">Purge-DLQ</span>
        </button>
        <div id="purgeStatus" style="display: none; flex: 1; padding: 0.75rem 1rem; background-color: hsl(175, 70%, 50%, 0.15); border: 1px solid var(--primary); border-radius: 0.375rem; color: var(--primary); font-size: 0.875rem;">
            Purge operation in progress...
        </div>
    </div>
</div>

<div id="emptyState" class="card" style="text-align: center; padding: 3rem 1.5rem;">
    <svg style="width: 4rem; height: 4rem; margin: 0 auto 1rem; color: var(--muted-foreground);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
    </svg>
    <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--foreground); margin-bottom: 0.5rem;">Select a Service Bus Entity</h3>
    <p style="color: var(--muted-foreground); max-width: 28rem; margin: 0 auto;">Choose a namespace and entity (queue or topic subscription) to view dead-letter queue statistics and management options.</p>
</div>

<div id="logsPanel" class="card" style="display: none; margin-top: 1.5rem; position: sticky; bottom: 1rem; max-height: 24rem; flex-direction: column; z-index: 5;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border);">
        <h3 style="font-size: 1rem; font-weight: 600; color: var(--foreground); margin: 0;">Live Logs</h3>
        <div style="display: flex; gap: 0.5rem;">
            <button id="downloadLogsButton" class="btn-secondary" style="padding: 0.5rem 0.75rem; font-size: 0.875rem;">
                <svg style="width: 1rem; height: 1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                Download
            </button>
            <button id="closeLogsButton" class="btn-secondary" style="padding: 0.5rem 0.75rem; font-size: 0.875rem;">Close</button>
        </div>
    </div>
    <div id="progressBar" style="height: 0.5rem; background-color: var(--card); border-radius: 0.25rem; overflow: hidden; margin-bottom: 1rem;">
        <div id="progressFill" style="height: 100%; width: 0%; background-color: var(--primary); transition: width 0.3s ease;"></div>
    </div>
    <div id="logsContent" style="flex: 1; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.875rem; line-height: 1.5; background-color: hsl(220, 15%, 6%); padding: 1rem; border-radius: 0.375rem; color: var(--foreground);">
        <div style="color: var(--muted-foreground);">Waiting for logs...</div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
    <script>
        const API_BASE = '/api/azure/servicebus';
        
        let currentSubscriptionId = '';
        let currentNamespace = null;
        let currentResourceGroup = '';

        const state = {
            namespaces: [],
            queues: [],
            topics: [],
            subscriptions: [],
            dlqCount: null
        };

        const elements = {
            namespaceSelector: document.getElementById('namespaceSelector'),
            namespaceSearchInput: document.getElementById('namespaceSearchInput'),
            namespaceDropdown: document.getElementById('namespaceDropdown'),
            namespaceList: document.getElementById('namespaceList'),
            entityTypeQueue: document.getElementById('entityTypeQueue'),
            entityTypeTopic: document.getElementById('entityTypeTopic'),
            queueSection: document.getElementById('queueSection'),
            topicSection: document.getElementById('topicSection'),
            queueSelector: document.getElementById('queueSelector'),
            topicSelector: document.getElementById('topicSelector'),
            topicSubscriptionSelector: document.getElementById('topicSubscriptionSelector'),
            dlqStatusCard: document.getElementById('dlqStatusCard'),
            emptyState: document.getElementById('emptyState'),
            dlqCount: document.getElementById('dlqCount'),
            activeCount: document.getElementById('activeCount'),
            entityTypeDisplay: document.getElementById('entityTypeDisplay'),
            refreshButton: document.getElementById('refreshButton'),
            purgeButton: document.getElementById('purgeButton')
        };

        function getSubscriptionId() {
            return localStorage.getItem('selectedSubscriptionId') || '';
        }

        async function fetchNamespaces() {
            const subscriptionId = getSubscriptionId();
            if (!subscriptionId) {
                elements.namespaceSearchInput.placeholder = 'Select an Azure subscription first...';
                elements.namespaceSearchInput.disabled = true;
                return;
            }

            elements.namespaceSearchInput.placeholder = 'Loading namespaces...';
            elements.namespaceSearchInput.disabled = true;
            elements.namespaceSearchInput.value = '';
            elements.namespaceSelector.value = '';
            currentNamespace = null;

            try {
                const response = await fetch(`${API_BASE}/namespaces?subscriptionId=${subscriptionId}`);
                if (!response.ok) throw new Error('Failed to fetch namespaces');
                
                state.namespaces = await response.json();
                elements.namespaceSearchInput.placeholder = 'Search namespaces...';
                elements.namespaceSearchInput.disabled = false;
            } catch (error) {
                console.error('Error fetching namespaces:', error);
                elements.namespaceSearchInput.placeholder = 'Failed to load namespaces';
                elements.namespaceSearchInput.disabled = false;
                alert('Failed to fetch Service Bus namespaces. Please ensure you are signed in and have the required permissions.');
            }
        }

        function filterAndShowNamespaces(searchTerm = '') {
            const filtered = state.namespaces.filter(ns => 
                ns.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                ns.location.toLowerCase().includes(searchTerm.toLowerCase())
            );

            elements.namespaceList.innerHTML = '';
            
            if (filtered.length === 0) {
                elements.namespaceList.innerHTML = `
                    <div style="padding: 0.75rem 1rem; color: var(--muted-foreground); text-align: center;">
                        No namespaces found
                    </div>
                `;
            } else {
                filtered.forEach(ns => {
                    const item = document.createElement('div');
                    item.style.cssText = `
                        padding: 0.75rem 1rem;
                        cursor: pointer;
                        transition: background-color 0.2s;
                        border-bottom: 1px solid var(--border);
                    `;
                    item.innerHTML = `
                        <div style="font-weight: 500; color: var(--foreground);">${ns.name}</div>
                        <div style="font-size: 0.875rem; color: var(--muted-foreground);">${ns.location}</div>
                    `;
                    
                    item.addEventListener('mouseenter', () => {
                        item.style.backgroundColor = 'hsl(220, 15%, 12%)';
                    });
                    
                    item.addEventListener('mouseleave', () => {
                        item.style.backgroundColor = '';
                    });
                    
                    item.addEventListener('click', () => {
                        selectNamespace(ns);
                    });
                    
                    elements.namespaceList.appendChild(item);
                });
            }
            
            elements.namespaceDropdown.style.display = 'block';
        }

        function selectNamespace(ns) {
            elements.namespaceSearchInput.value = `${ns.name} (${ns.location})`;
            elements.namespaceSelector.value = ns.name;
            currentNamespace = ns.name;
            currentResourceGroup = ns.resourceGroup;
            currentSubscriptionId = getSubscriptionId();
            
            elements.namespaceDropdown.style.display = 'none';
            
            // Clear downstream selections
            elements.queueSelector.innerHTML = '<option value="">Loading...</option>';
            elements.topicSelector.innerHTML = '<option value="">Loading...</option>';
            elements.queueSelector.disabled = true;
            elements.topicSelector.disabled = true;
            elements.topicSubscriptionSelector.disabled = true;
            
            elements.dlqStatusCard.style.display = 'none';
            elements.emptyState.style.display = 'block';

            if (currentNamespace) {
                if (elements.entityTypeQueue.checked) {
                    fetchQueues();
                } else {
                    fetchTopics();
                }
            }
        }

        async function fetchQueues() {
            if (!currentNamespace || !currentSubscriptionId) return;

            try {
                const response = await fetch(
                    `${API_BASE}/queues?subscriptionId=${currentSubscriptionId}&resourceGroup=${currentResourceGroup}&namespaceName=${currentNamespace}`
                );
                if (!response.ok) throw new Error('Failed to fetch queues');
                
                state.queues = await response.json();
                populateQueues();
            } catch (error) {
                console.error('Error fetching queues:', error);
            }
        }

        function populateQueues() {
            elements.queueSelector.innerHTML = '<option value="">Select a queue...</option>';
            state.queues.forEach(queue => {
                const option = document.createElement('option');
                option.value = queue.name;
                option.textContent = queue.name;
                elements.queueSelector.appendChild(option);
            });
            elements.queueSelector.disabled = false;
        }

        async function fetchTopics() {
            if (!currentNamespace || !currentSubscriptionId) return;

            try {
                const response = await fetch(
                    `${API_BASE}/topics?subscriptionId=${currentSubscriptionId}&resourceGroup=${currentResourceGroup}&namespaceName=${currentNamespace}`
                );
                if (!response.ok) throw new Error('Failed to fetch topics');
                
                state.topics = await response.json();
                populateTopics();
            } catch (error) {
                console.error('Error fetching topics:', error);
            }
        }

        function populateTopics() {
            elements.topicSelector.innerHTML = '<option value="">Select a topic...</option>';
            state.topics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic.name;
                option.textContent = topic.name;
                elements.topicSelector.appendChild(option);
            });
            elements.topicSelector.disabled = false;
        }

        async function fetchSubscriptions(topicName) {
            if (!currentNamespace || !currentSubscriptionId || !topicName) return;

            try {
                const response = await fetch(
                    `${API_BASE}/topics/${topicName}/subscriptions?subscriptionId=${currentSubscriptionId}&resourceGroup=${currentResourceGroup}&namespaceName=${currentNamespace}`
                );
                if (!response.ok) throw new Error('Failed to fetch subscriptions');
                
                state.subscriptions = await response.json();
                populateSubscriptions();
            } catch (error) {
                console.error('Error fetching subscriptions:', error);
            }
        }

        function populateSubscriptions() {
            elements.topicSubscriptionSelector.innerHTML = '<option value="">Select a subscription...</option>';
            state.subscriptions.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.name;
                option.textContent = sub.name;
                elements.topicSubscriptionSelector.appendChild(option);
            });
            elements.topicSubscriptionSelector.disabled = false;
        }

        async function fetchDlqCount() {
            const entityType = elements.entityTypeQueue.checked ? 'queue' : 'topic';
            let entityName = '';
            let topicSubscriptionName = null;

            if (entityType === 'queue') {
                entityName = elements.queueSelector.value;
            } else {
                entityName = elements.topicSelector.value;
                topicSubscriptionName = elements.topicSubscriptionSelector.value;
            }

            if (!entityName || (entityType === 'topic' && !topicSubscriptionName)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/dlq/count`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subscriptionId: currentSubscriptionId,
                        resourceGroup: currentResourceGroup,
                        namespace: currentNamespace,
                        entityType: entityType,
                        entityName: entityName,
                        topicSubscriptionName: topicSubscriptionName
                    })
                });

                if (!response.ok) throw new Error('Failed to fetch DLQ count');
                
                const data = await response.json();
                state.dlqCount = data;
                displayDlqCount(data);
            } catch (error) {
                console.error('Error fetching DLQ count:', error);
                alert('Failed to fetch DLQ count. Please try again.');
            }
        }

        function displayDlqCount(data) {
            elements.dlqCount.textContent = data.deadLetterCount.toLocaleString();
            elements.activeCount.textContent = data.activeCount.toLocaleString();
            elements.entityTypeDisplay.textContent = data.entityType;
            
            elements.purgeButton.disabled = data.deadLetterCount === 0;
            
            elements.emptyState.style.display = 'none';
            elements.dlqStatusCard.style.display = 'block';
        }

        // Search input event listeners
        elements.namespaceSearchInput.addEventListener('input', function() {
            const searchTerm = this.value;
            if (state.namespaces.length > 0) {
                filterAndShowNamespaces(searchTerm);
            }
        });

        elements.namespaceSearchInput.addEventListener('focus', function() {
            if (state.namespaces.length > 0) {
                filterAndShowNamespaces(this.value);
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!elements.namespaceSearchInput.contains(e.target) && 
                !elements.namespaceDropdown.contains(e.target)) {
                elements.namespaceDropdown.style.display = 'none';
            }
        });

        elements.entityTypeQueue.addEventListener('change', function() {
            if (this.checked) {
                elements.queueSection.style.display = 'grid';
                elements.topicSection.style.display = 'none';
                elements.dlqStatusCard.style.display = 'none';
                elements.emptyState.style.display = 'block';
                
                if (currentNamespace) {
                    fetchQueues();
                }
            }
        });

        elements.entityTypeTopic.addEventListener('change', function() {
            if (this.checked) {
                elements.queueSection.style.display = 'none';
                elements.topicSection.style.display = 'grid';
                elements.dlqStatusCard.style.display = 'none';
                elements.emptyState.style.display = 'block';
                
                if (currentNamespace) {
                    fetchTopics();
                }
            }
        });

        elements.queueSelector.addEventListener('change', function() {
            if (this.value) {
                fetchDlqCount();
            } else {
                elements.dlqStatusCard.style.display = 'none';
                elements.emptyState.style.display = 'block';
            }
        });

        elements.topicSelector.addEventListener('change', function() {
            const topicName = this.value;
            elements.topicSubscriptionSelector.innerHTML = '<option value="">Loading...</option>';
            elements.topicSubscriptionSelector.disabled = true;
            elements.dlqStatusCard.style.display = 'none';
            elements.emptyState.style.display = 'block';
            
            if (topicName) {
                fetchSubscriptions(topicName);
            }
        });

        elements.topicSubscriptionSelector.addEventListener('change', function() {
            if (this.value) {
                fetchDlqCount();
            } else {
                elements.dlqStatusCard.style.display = 'none';
                elements.emptyState.style.display = 'block';
            }
        });

        elements.refreshButton.addEventListener('click', function() {
            fetchDlqCount();
        });

        elements.purgeButton.addEventListener('click', async function() {
            if (!confirm('This will permanently delete all messages in the dead-letter queue. This action cannot be undone. Continue?')) {
                return;
            }

            const entityType = elements.entityTypeQueue.checked ? 'queue' : 'topic';
            let entityName = '';
            let topicSubscriptionName = null;

            if (entityType === 'queue') {
                entityName = elements.queueSelector.value;
            } else {
                entityName = elements.topicSelector.value;
                topicSubscriptionName = elements.topicSubscriptionSelector.value;
            }

            if (!entityName || (entityType === 'topic' && !topicSubscriptionName)) {
                alert('Please select an entity first.');
                return;
            }

            const logsPanel = document.getElementById('logsPanel');
            const logsContent = document.getElementById('logsContent');
            const purgeStatus = document.getElementById('purgeStatus');
            const progressFill = document.getElementById('progressFill');
            const closeLogsButton = document.getElementById('closeLogsButton');
            const downloadLogsButton = document.getElementById('downloadLogsButton');

            elements.purgeButton.disabled = true;
            purgeStatus.style.display = 'flex';
            purgeStatus.textContent = 'Connecting to Service Bus...';
            logsPanel.style.display = 'flex';
            logsContent.innerHTML = '<div style="color: var(--primary);">[' + new Date().toLocaleTimeString() + '] Starting purge operation...</div>';
            progressFill.style.width = '10%';

            let allLogs = [];

            function addLogEntry(message, isError = false) {
                const timestamp = new Date().toLocaleTimeString();
                const color = isError ? '#ff6b6b' : 'var(--foreground)';
                logsContent.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
                logsContent.scrollTop = logsContent.scrollHeight;
                allLogs.push(`[${timestamp}] ${message}`);
            }

            try {
                addLogEntry('Sending purge request...');
                progressFill.style.width = '25%';
                purgeStatus.textContent = 'Purging dead-letter messages...';

                const response = await fetch(`${API_BASE}/dlq/purge`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subscriptionId: currentSubscriptionId,
                        resourceGroup: currentResourceGroup,
                        namespace: currentNamespace,
                        entityType: entityType,
                        entityName: entityName,
                        topicSubscriptionName: topicSubscriptionName
                    })
                });

                progressFill.style.width = '75%';

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to purge DLQ');
                }

                const result = await response.json();
                progressFill.style.width = '100%';

                if (result.logs && result.logs.length > 0) {
                    result.logs.forEach(log => addLogEntry(log));
                }

                if (result.success) {
                    purgeStatus.textContent = `Purge completed! ${result.totalPurged} messages deleted in ${result.elapsedSeconds}s`;
                    purgeStatus.style.backgroundColor = 'hsl(120, 70%, 50%, 0.15)';
                    purgeStatus.style.borderColor = 'hsl(120, 70%, 50%)';
                    purgeStatus.style.color = 'hsl(120, 70%, 50%)';
                    addLogEntry(`SUCCESS: Purged ${result.totalPurged} messages in ${result.elapsedSeconds} seconds`);
                } else {
                    purgeStatus.textContent = `Purge failed: ${result.error}`;
                    purgeStatus.style.backgroundColor = 'hsl(0, 70%, 50%, 0.15)';
                    purgeStatus.style.borderColor = 'hsl(0, 70%, 50%)';
                    purgeStatus.style.color = 'hsl(0, 70%, 50%)';
                    addLogEntry(`ERROR: ${result.error}`, true);
                }

                await fetchDlqCount();

            } catch (error) {
                console.error('Error purging DLQ:', error);
                progressFill.style.width = '100%';
                progressFill.style.backgroundColor = 'hsl(0, 70%, 50%)';
                purgeStatus.textContent = `Error: ${error.message}`;
                purgeStatus.style.backgroundColor = 'hsl(0, 70%, 50%, 0.15)';
                purgeStatus.style.borderColor = 'hsl(0, 70%, 50%)';
                purgeStatus.style.color = 'hsl(0, 70%, 50%)';
                addLogEntry(`ERROR: ${error.message}`, true);
            } finally {
                elements.purgeButton.disabled = false;
            }

            closeLogsButton.addEventListener('click', function() {
                logsPanel.style.display = 'none';
                purgeStatus.style.display = 'none';
                purgeStatus.style.backgroundColor = 'hsl(175, 70%, 50%, 0.15)';
                purgeStatus.style.borderColor = 'var(--primary)';
                purgeStatus.style.color = 'var(--primary)';
                progressFill.style.width = '0%';
                progressFill.style.backgroundColor = 'var(--primary)';
            });

            downloadLogsButton.addEventListener('click', function() {
                const blob = new Blob([allLogs.join('\n')], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dlq-purge-logs-${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        });

        // Listen for subscription changes from the same page (custom event)
        window.addEventListener('subscriptionChanged', function(e) {
            fetchNamespaces();
        });

        // Listen for subscription changes from other tabs/windows (storage event)
        window.addEventListener('storage', function(e) {
            if (e.key === 'selectedSubscriptionId') {
                fetchNamespaces();
            }
        });

        fetchNamespaces();
    </script>
}
